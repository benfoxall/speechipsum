<!DOCTYPE html>
<html>
  <head>
    <title>Speechipsum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-wip/css/bootstrap.min.css">
  </head>
  <body>

    <div class="jumbotron">
      <div class="container">
        <h1>
          <a href="http://www.speechipsum.com/">Speechipsum</a>
        </h1>
        <p>create ipsums by speaking to your computer</p>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <p>
            <button id="speak" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-search"></span>Start listening</button>
          </p>

          <p id="help">
            This requires <a href="http://updates.html5rocks.com/2013/01/Voice-Driven-Web-Apps-Introduction-to-the-Web-Speech-API"><code>webkitSpeechRecognition</code></a> (ie. chrome desktop)
          </p>

          <div class="form">
            <div class="form-group">
              <textarea class="form-control" id="source" rows="5" placeholder="don't feel like talking? Be old-fashioned and type some words in here"></textarea>
            </div>
          </div>

          <hr />

          <blockquote class="well">
            <p id="output"></p>
          </blockquote>

          <hr />

          <footer>
            <small>
              hacked together by <a href="https://twitter.com/benjaminbenben">@benjaminbenben</a>
            </small>
          </footer>

        </div>
      </div>
    </div>

    <script type="text/javascript">
      function Ipsum(){}
      Ipsum.prototype = {
        source:  function(text){
          this.tokens = text.split(/\s/);
          this.map = {}

          var tok, prior = '';
          for (var i = 0; i < this.tokens.length; i++) {
            tok = this.tokens[i];

            this.map[prior] = this.map[prior] || {};
            this.map[prior][tok] = (this.map[prior][tok] || 0) + 1;

            prior = tok;
          };

          // generate
          prior='';
          this.output = '';

          var paragraphs = 3;
          while(paragraphs--){
              var countdown = 60
              while(countdown--){
                var options = Object.keys(this.map[prior]),
                    i = Math.floor(Math.random()*(options.length));
                //random for now

                this.output += options[i] + ' '
                prior = this.map[options[i]] ? options[i] : '';
              }

              this.output += '\n\n'
          }
          // console.log(this.output);
        }
      }


      var ipsum = new Ipsum();

      function update(){
        ipsum.source(source.value)        

        output.innerText = ipsum.output;
      }

      // update when someone types in the input
      source.addEventListener('keyup', update, false);

      // all from - http://updates.html5rocks.com/tag/voice
      if('webkitSpeechRecognition' in window ){
        var started,
            final_transcript = '',
            recognition = new webkitSpeechRecognition();

        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = function(event) {
          var interim_transcript = '';

          for (var i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              final_transcript += event.results[i][0].transcript;
            } else {
              interim_transcript += event.results[i][0].transcript;
            }
          }
          source.value = final_transcript + interim_transcript;

          update()
        };

        recognition.onstart = function() {
          speak.innerText = 'Stop listening'
          speak.className = 'btn btn-danger btn-lg';
          started = true;
        }

        recognition.onend = function() {
          speak.innerText = 'Start listening'
          speak.className = 'btn btn-primary btn-lg';
          started = false;
        }

        speak.addEventListener('click', function(){
          if(!started)
            recognition.start()
          else
            recognition.stop()
        }, false)


      } else {
        //awww
        speak.className = 'btn btn-primary disabled';
        help.className = 'text-danger'
      }



      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-35774866-4', 'speechipsum.com');
      ga('send', 'pageview');


    </script>
  </body>
</html>